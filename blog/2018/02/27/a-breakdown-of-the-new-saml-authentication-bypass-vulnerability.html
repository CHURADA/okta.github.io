<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager
    }
  </script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="A Breakdown of the New SAML Authentication Bypass Vulnerability | Okta Developer">
  <meta class="swiftype" name="summary" data-type="string" content="An in-depth look at the new SAML authentication bypass vulnerability: what it is, how it works, and how you can protect yourself against it." />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-9cafcbcda0dfe686bf4c513405579bab5aeda9909c278a37b465dbc8bbfaac6d.css">
  
  
  <title>A Breakdown of the New SAML Authentication Bypass Vulnerability | Okta Developer</title>
  <meta name="description" content="An in-depth look at the new SAML authentication bypass vulnerability: what it is, how it works, and how you can protect yourself against it.">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#21313a">
  <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first expanded">
          <a href="https://developer.okta.com/product/">Product</a>
          <ul class="menu">
            <li class="first leaf"><a href="https://developer.okta.com/product/">Overview</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authentication/">Authentication</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authorization/">Authorization</a></li>
            <li class="last leaf"><a href="https://developer.okta.com/product/user-management/">User Management</a></li>
          </ul>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/rdegges" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/rdegges" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="https://www.rdegges.com" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">

    <header class="BlogPost-header">

        <time class="BlogPost-date" datetime="2018-02-27">February 27, 2018</time>

        <h1 class="BlogPost-title">
            
            A Breakdown of the New SAML Authentication Bypass Vulnerability
            
        </h1>

        <div class="BlogPost-attribution">
            
            <img src="/assets/avatar-rdegges-9fb23ebb06890fb7924b8ceb3a28d666ae4ae1a297a3cddf517e549547e5dfe3.jpg" alt="avatar-rdegges.jpg" class="BlogPost-avatar">
            
            <span class="BlogPost-author">Randall Degges</span>
        </div>

    </header>

    <div class="BlogPost-content">
        
	<p>Several weeks ago a new critical vulnerability was discovered that affects many SAML implementations. This vulnerability was first reported by <a href="https://twitter.com/kelbyludwig">Kelby Ludwig</a> of Duo Security and is particularly interesting to us (as a user management company) as it can be used to bypass authentication in a sinisterly simplistic way.</p>

<p>In this post we’ll take an in-depth look at this new SAML vulnerability, what it is, how it works, and what you need to know to protect yourself.</p>

<p><strong>NOTE</strong>: Just in case you’re wondering whether or not Okta is vulnerable to this new issue: <em>we aren’t</em> &gt;;)</p>

<h2 id="what-is-the-new-saml-authentication-bypass-vulnerability">What is the New SAML Authentication Bypass Vulnerability?</h2>

<p>It is a new attack which has the potential to directly affect single sign-on (<a href="https://wiki.oasis-open.org/security/FrontPage#SAML_V2.0_Standard">SAML</a>) security.</p>

<p>If you’re not familiar with SAML (short for Security Assertion Markup Language), it’s an open standard that allows users to share credentials between multiple web apps so they don’t need to manually log in when accessing different web services. Many vendors use SAML to handle user authentication and authorization so their users can access web applications without needing individual credentials for each.</p>

<p>The new SAML vulnerability allows an attacker to <em>bypass authentication</em> and directly assume the role of an authenticated user as part of the SAML flow. <strong>This is a BIG DEAL.</strong></p>

<h2 id="how-the-new-saml-authentication-bypass-vulnerability-works">How the new SAML Authentication Bypass Vulnerability Works</h2>

<p>When a user is authenticating to a website using SAML, there are always three parties involved:</p>

<ul>
  <li>A user in a web browser</li>
  <li>A service provider running a website that user is trying to access (EG: Salesforce)</li>
  <li>An identity provider that stores and manages the user’s account and credentials (EG: Okta)</li>
</ul>

<p>At some point during SAML authentication the service provider (EG: Salesforce) will ask the identity provider (EG: Okta): who is this person that’s trying to log into me? It’s then the identity provider’s (EG: Okta) job to generate a SAML assertion (a big XML document) and send it back to the service provider. This SAML assertion contains all the user information necessary for the service provider (EG: Salesforce) to log this user in without ever needing their password.</p>

<p><strong>NOTE</strong>: This is an extreme oversimplification of how SAML works, but accurately covers the important bits needed to understand more about the new vulnerability.</p>

<p>Here’s what a simplified SAML assertion might look like:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;saml:Assertion</span> <span class="na">ID=</span><span class="s">"123"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;saml:Issuer&gt;</span>www.okta.com<span class="nt">&lt;/saml:Issuer&gt;</span>
  <span class="nt">&lt;saml:Subject&gt;</span>
    <span class="nt">&lt;saml:NameID&gt;</span>randall.degges@okta.com<span class="nt">&lt;/saml:NameID&gt;</span>
  <span class="nt">&lt;/saml:Subject&gt;</span>
  <span class="nt">&lt;saml:Conditions</span>
                   <span class="na">NotBefore=</span><span class="s">"2018-02-27T00:00:00Z"</span>
                   <span class="na">NotOnOrAfter=</span><span class="s">"2018-02-28T00:00:00Z"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;saml:AudienceRestriction&gt;</span>
      <span class="nt">&lt;saml:Audience&gt;</span>www.salesforce.com<span class="nt">&lt;/saml:Audience&gt;</span>
    <span class="nt">&lt;/saml:AudienceRestriction&gt;</span>
  <span class="nt">&lt;/saml:Conditions&gt;</span>
<span class="nt">&lt;/saml:Assertion&gt;</span>
</code></pre></div></div>

<p>Looking at the XML sample above, one thing stands out above all else: the <code class="highlighter-rouge">saml:NameID</code> element. This element is responsible for identifying the user who’s about to be logged in. In an actual SAML assertion, there’d be a lot of other stuff included. You’d also see things like:</p>

<ul>
  <li>User attributes (first name, last name, etc.)</li>
  <li>User roles/permissions (is this user an admin? can they access a certain feature? etc.)</li>
  <li>An XML signature (this is required by almost all SAML vendors). XML signatures are frequently used to cryptographically sign the assertion element so that the service provider (EG: Salesforce) can ensure the SAML assertion it receives from the identity provider is valid and accurate (and has not been modified by an attacker).</li>
</ul>

<p>The service provider (EG: Salesforce) relies on the data in this XML document to properly authenticate a user, so it’s critical that this information be accurate. Anddddd, as you might suspect, this is exactly where the new vulnerability comes into play.</p>

<p>It takes advantage of two potential issues in a SAML library implementation:</p>

<ul>
  <li>XML parsing issues and</li>
  <li>Cryptographic signing issues in <a href="https://www.w3.org/TR/xmldsig-core2/">XMLDSIG</a> (a specification which is used to generate and validate XML signatures)</li>
</ul>

<h3 id="xml-parsing-issues">XML Parsing Issues</h3>

<p>XML can be quite complicated.</p>

<p>Let’s say, for a moment, that a SAML assertion contains a <code class="highlighter-rouge">saml:NameID</code> element like the one below:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;saml:NameID&gt;</span>not-an-admin@okta.com<span class="nt">&lt;/saml:NameID&gt;</span>
</code></pre></div></div>

<p>What do you think happens to the XML tree when this element is parsed? It looks something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NameID
|_ Text: not-an-admin@okta.com
</code></pre></div></div>

<p>Most SAML libraries will parse the <code class="highlighter-rouge">saml:NameID</code> element out of the XML tree, extracting the last text element inside of it and will use that value to identify the user logging in.</p>

<p>But… What happens if you break the <code class="highlighter-rouge">saml:NameID</code> element up such that it contains an XML comment?</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;saml:NameID&gt;</span>not-an-<span class="c">&lt;!-- this is a comment --&gt;</span>admin@okta.com<span class="nt">&lt;/saml:NameID&gt;</span>
</code></pre></div></div>

<p>In this scenario, the XML tree, when parsed, will look like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NameID
|_ Text: not-an-
|_ Comment: this is a comment
|_ Text: admin@okta.com
</code></pre></div></div>

<p>And depending on the XML parsing logic used in the SAML library, you can probably see where this is headed: depending on where you insert a comment you can dramatically impact that identity of the user that’s being logged in!</p>

<p>This is <strong>bad news</strong> for web security as a simple XML comment can cause a SAML implementation to incorrectly authenticate a user.</p>

<h3 id="cryptographic-signing-issues">Cryptographic Signing Issues</h3>

<p>The second issue the new SAML vulnerability takes advantage of is the relatively “weak” protection provided by XMLDSIG’s canonicalization algorithms that are used to create and validate XML signatures.</p>

<p>Typically, when a SAML assertion is created, the assertion element itself is cryptographically signed. This helps the service provider (EG: Salesforce) trust that the user they’re about to log in is valid. Unfortuantely however, there are several different types of canonicalization algorithms that are allowed to be used when XML signatures are created, and most of them are not well-suited for creating tamper-proof data.</p>

<p>Let’s take some basic XML, for example:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>     hi        <span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<p>The XML document above would have the <em>exact same cryptographic signature</em> as the XML document below:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>hi<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<p>This is because XML doesn’t care about whitespace. When the XML document is analyzed before a signature is created, the space is removed.</p>

<p>What this new vulnerability takes advantage of, specifically, is the fact that most canonicalization algorithms <em>also</em> don’t care about comments. This means that the following two XML documents (while vastly different in parseability as noted in the previous section) will have <em>identical</em> cryptographic signatures: thereby allowing an attacker to sneak a comment into a SAML assertion and bypass authentication without ever raising any red flags in signature checks :(</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;saml:NameID&gt;</span>not-an-<span class="c">&lt;!-- this is a comment --&gt;</span>admin@okta.com<span class="nt">&lt;/saml:NameID&gt;</span>
</code></pre></div></div>

<p>and</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;saml:NameID&gt;</span>not-an-admin@okta.com<span class="nt">&lt;/saml:NameID&gt;</span>
</code></pre></div></div>

<p>While it is theoretically possible for all SAML vendors to only allow a specific canonicalization algorithm which DOES leave XML documents unmodified (so that they contain things like whitespace, comments, etc.), in practice this would be hard to enforce across vendors and implementations.</p>

<p>To read more about XML canonicalization issues you might want to check out the <a href="https://en.wikipedia.org/wiki/XML_Signature#XML_canonicalization">Wikipedia article</a> on the topic.</p>

<h2 id="how-to-protect-yourself-from-the-new-saml-authentication-bypass-vulnerability">How to Protect Yourself from the New SAML Authentication Bypass Vulnerability</h2>

<p>If your company is using SAML you will want to <em>check with your SAML vendors</em> to ensure they are not susceptible to this new vulnerability. <a href="https://developer.okta.com/">Okta</a>, by the way, <strong>is not vulnerable</strong> &gt;:)</p>

<p>If you’re a developer building systems to integrate with SAML vendors or single sign-on providers, try to NOT integrate using SAML if possible. Instead: use a more modern identity standard such as OpenID Connect.</p>

<p>OpenID Connect is a lot simpler than SAML, doesn’t use XML or <a href="https://www.w3.org/TR/xmldsig-core1/">XMLDSIG</a>, and is far less susceptible to attacks like these since it doesn’t rely on XML parsers. There’s a long, complex history with XML and SAML – many of the SAML vulnerabilities that have been found over the last ~15 years are centered around XML parsing (just like this one).</p>

<p>Take, for instance, <a href="https://www.youtube.com/watch?v=QLKM4USUlZs">XML Signature Wrapping</a> attacks which have been known about since ~2002 but are still finding their way into modern SAML implementations as recently as 2014.</p>

<p>If possible, avoid SAML and use <a href="https://developer.okta.com/blog/2017/07/25/oidc-primer-part-1">OpenID Connect</a> whenever you can. If you must use SAML, check your SAML library (and its underlying XML parsing/validation/signature libraries) to ensure it is NOT vulnerable to the new attack.</p>

<p>Duo has graciously audited several popular SAML libraries and found that:</p>

<ul>
  <li>OneLogin’s <a href="https://github.com/onelogin/python-saml">python-saml</a>,</li>
  <li>OneLogin’s <a href="https://github.com/onelogin/ruby-saml">ruby-saml</a>,</li>
  <li>Clever’s <a href="https://github.com/Clever/saml2">saml2</a>,</li>
  <li><a href="https://github.com/omniauth/omniauth-saml">omniauth-saml</a>, and</li>
  <li>Shibboleth’s <a href="https://www.shibboleth.net/products/opensaml-cpp/">openSAML C++</a></li>
</ul>

<p>are all vulnerable with many other libraries also likely to be affected.</p>

<p>If you are the author of a SAML library, there are two important steps you can take immediately to protect your users:</p>

<ol>
  <li>
    <p>Look for an option in whatever XML library you’re using to remove all comments when creating and parsing XML documents. By strategically purging all XML comments upfront you’ll be able to avoid this issue entirely by never allowing a comment to leak into your XML tree.</p>

    <p>If the XML library you’re using doesn’t support purging comments, you can always work with the XML library maintainers to add this functionality or swap to a new XML library.</p>
  </li>
  <li>
    <p>When parsing nodes from an XML element tree using your XML parsing library, immediately bail out if you detect more than one child node exists for SAML nodes. This way, if you do stumble across a <code class="highlighter-rouge">saml:NameId</code> node (or any other SAML node) that contains more than one child, you won’t make the mistake of using just the first or last child values.</p>

    <p>You should also avoid concatenating child values together as there may be a potential way to attack these values in the future.</p>
  </li>
</ol>

<p>Be safe out there.</p>

<p>If you have any questions, comments, or suggestions: please drop us a note in a comment below or <a href="https://twitter.com/oktadev">hit us up</a> on Twitter.</p>


    </div>

    
    <div id="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_title = 'A Breakdown of the New SAML Authentication Bypass Vulnerability';
            var disqus_url = 'https://developer.okta.com/blog/2018/02/27/a-breakdown-of-the-new-saml-authentication-bypass-vulnerability';

            (function () {
                var dsq = document.createElement('script');
                dsq.async = true;
                dsq.type = 'text/javascript';
                dsq.src = '//oktadevblog.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>
              Please enable JavaScript to view the
              <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus</a>.
         </noscript>
    </div>
    
</article>

		
</section>

		
	</div><footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">
                <a href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <div class="Logo">
                        <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    </div>
                    <p>Visit okta.com</p>
                </a>
            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">
                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/change-log/">Change Log</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="https://developer.okta.com/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="https://developer.okta.com/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="https://developer.okta.com/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-aa397c892d9083236c5cb20732dde679021b9236c8142ce78177b8b184567a02.js"></script>
    <script type="text/javascript" src="/assets/myOkta-911cbafbbe079b7a5522d9cbe15bd2a5f44e1582531e88393934bec69f97696b.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
