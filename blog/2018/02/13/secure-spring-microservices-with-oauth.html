<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager

      // Start Heap Analytics
      window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
      heap.load("3356162945");
      // End Heap Analytics
    }
  </script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="Secure a Spring Microservices Architecture with Spring Security and OAuth 2.0 | Okta Developer">
  <meta class="swiftype" name="summary" data-type="string" content="Secure a Spring microservices architecture with Spring Security and OAuth + this tutorial. No Okta SDKs required!" />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-5709780bae87480dbcdc9610d80786f64ecd7c7f9f16a3215f689067ddb318f4.css">
  
  
  <title>Secure a Spring Microservices Architecture with Spring Security and OAuth 2.0 | Okta Developer</title>
  <meta name="description" content="Secure a Spring microservices architecture with Spring Security and OAuth + this tutorial. No Okta SDKs required!">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#21313a">
  <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first expanded">
          <a href="https://developer.okta.com/product/">Product</a>
          <ul class="menu">
            <li class="first leaf"><a href="https://developer.okta.com/product/">Overview</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authentication/">Authentication</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authorization/">Authorization</a></li>
            <li class="last leaf"><a href="https://developer.okta.com/product/user-management/">User Management</a></li>
          </ul>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/mraible" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/mraible" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="http://raibledesigns.com" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">

    <header class="BlogPost-header">

        <time class="BlogPost-date" datetime="2018-02-13">February 13, 2018</time>

        <h1 class="BlogPost-title">
            
            Secure a Spring Microservices Architecture with Spring Security and OAuth 2.0
            
        </h1>

        <div class="BlogPost-attribution">
            
            <img src="/assets/avatar-matt_raible-9974af6192eb1753b7137c8fff0a2c6e6bb9736a2517986cb5cc50bb040e83d4.jpg" alt="avatar-matt_raible.jpg" class="BlogPost-avatar">
            
            <span class="BlogPost-author">Matt Raible</span>
        </div>

    </header>

    <div class="BlogPost-content">
        
	<p>Building a microservices architecture with Spring Boot and Spring Cloud can allow your team to scale and develop software faster. It can add resilience and elasticity to your architecture that will enable it to fail gracefully and scale infinitely. All this is great, but you need continuous deployment and excellent security to ensure your system stays up-to-date, healthy, and safe for years to come.</p>

<p>With Spring Security and its OAuth 2.0 support, you have everything you need to lock down your API gateway, as well as your backend servers. You can set it up to automatically propagate your access tokens from one app to the other, ensuring that everything stays secure and encrypted along the way.</p>

<p>This tutorial shows you how to use Spring Security with OAuth and Okta to lock down your microservices architecture. You might remember a similar post I wrote back in August: <a href="/blog/2017/08/08/secure-spring-microservices">Secure a Spring Microservices Architecture with Spring Security, JWTs, Juiser, and Okta</a>. The difference in this post is you won’t be using any Okta SDKs; Spring Security OAuth has everything you need!</p>

<h2 id="microservices-architectures-with-spring-boot--spring-cloud">Microservices Architectures with Spring Boot + Spring Cloud</h2>

<p>This tutorial shows you how to add security to a previous tutorial I wrote, <a href="/blog/2017/06/15/build-microservices-architecture-spring-boot">Build a Microservices Architecture for Microbrews with Spring Boot</a>. A basic microservices architecture with Spring Boot and Spring Cloud looks like the graphic below.</p>

<p><img src="/assets/blog/microservices-spring-oauth/spring-microservices-diagram-80e5f67db4e5949ef92dfe0b38bf0008c4f1cdc350392e81a3e6ae0206077b21.png" alt="Spring Boot + Cloud Microservices Architecture" width="700" class="center-image" /></p>

<p>Once you’ve completed this tutorial, you’ll have Spring Security locking things down, and Okta providing authorization with OAuth. Your Edge Service (a.k.a., API Gateway) will have a Feign client that passes along your access token, and Hystrix that handles graceful failover.</p>

<p><img src="/assets/blog/microservices-spring-oauth/spring-oauth-microservices-diagram-fd05c823c91d9bf07852680ce520222b65eb173d5b122df1756f693cd7fbf810.png" alt="Spring Microservices with OAuth" width="800" class="center-image" /></p>

<p>To begin, you’ll need to clone the aforementioned article’s completed project.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/oktadeveloper/spring-boot-microservices-example.git
</code></pre></div></div>

<h2 id="create-a-web-application-in-okta">Create a Web Application in Okta</h2>

<p>If you don’t have one yet, <a href="https://developer.okta.com/signup/">create a forever-free Okta Developer account</a>. After you’ve completed the setup process, log in to your account and navigate to <strong>Applications</strong> &gt; <strong>Add Application</strong>. Click <strong>Web</strong> and <strong>Next</strong>. On the next page, enter the following values and click <strong>Done</strong>.</p>

<ul>
  <li>Application Name: <code class="highlighter-rouge">Spring OAuth</code></li>
  <li>Base URIs: <code class="highlighter-rouge">http://localhost:8081</code></li>
  <li>Login redirect URIs: <code class="highlighter-rouge">http://localhost:8081/login</code></li>
</ul>

<p>Take note of the clientId and client secret values as you’ll need these to configure your Spring Boot apps.</p>

<h2 id="add-spring-security-oauth-to-the-edge-service-application">Add Spring Security OAuth to the Edge Service Application</h2>

<p>The <strong>edge-service</strong> application handles the communication with the <code class="highlighter-rouge">beer-catalog-service</code>, so it’s the best place to start integrating OAuth. In <code class="highlighter-rouge">edge-service/pom.xml</code>, add dependencies for Spring Security, its OAuth support, and its JWT support.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>Add the following Zuul routes to <code class="highlighter-rouge">edge-service/src/main/resources/application.properties</code>.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">zuul.routes.beer-catalog-service.path</span><span class="p">=</span><span class="s">/beers</span>
<span class="py">zuul.routes.beer-catalog-service.url</span><span class="p">=</span><span class="s">http://localhost:8080</span>

<span class="py">zuul.routes.home.path</span><span class="p">=</span><span class="s">/home</span>
<span class="py">zuul.routes.home.url</span><span class="p">=</span><span class="s">http://localhost:8080</span>
</code></pre></div></div>

<p>Open <code class="highlighter-rouge">edge-service/src/main/java/com/example/EdgeServiceApplication.java</code> and add <code class="highlighter-rouge">@EnableOAuth2Sso</code> to enable authentication with OAuth.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.security.oauth2.client.EnableOAuth2Sso</span><span class="o">;</span>
<span class="o">...</span>
<span class="nd">@EnableOAuth2Sso</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EdgeServiceApplication</span> <span class="o">{</span>
</code></pre></div></div>

<p>Adding <code class="highlighter-rouge">@EnableOAuth2Sso</code> causes Spring Security to look for a number of properties. Add the following properties to <code class="highlighter-rouge">edge-service/src/main/resources/application.properties</code>.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">security.oauth2.client.client-id</span><span class="p">=</span><span class="s">{yourClientId}</span>
<span class="py">security.oauth2.client.client-secret</span><span class="p">=</span><span class="s">{yourClientSecret}</span>
<span class="py">security.oauth2.client.access-token-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/token</span>
<span class="py">security.oauth2.client.user-authorization-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/authorize</span>
<span class="py">security.oauth2.client.scope</span><span class="p">=</span><span class="s">openid profile email</span>
<span class="py">security.oauth2.resource.filter-order</span><span class="p">=</span><span class="s">3</span>
<span class="py">security.oauth2.resource.user-info-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/userinfo</span>
<span class="py">security.oauth2.resource.token-info-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/introspect</span>
<span class="py">security.oauth2.resource.prefer-token-info</span><span class="p">=</span><span class="s">false</span>
</code></pre></div></div>

<p><strong>TIP:</strong> If you see <code class="highlighter-rouge">{yourOktaDomain}</code> in the above code snippet, log in to your Okta account and refresh this page. It will replace this value with your domain.</p>

<p>Add a <code class="highlighter-rouge">ResourceServerConfig.java</code> class to the same package as <code class="highlighter-rouge">EdgeServiceApplication</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">edgeservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.util.matcher.RequestHeaderRequestMatcher</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableResourceServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">requestMatcher</span><span class="o">(</span><span class="k">new</span> <span class="n">RequestHeaderRequestMatcher</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
            <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>At this point, you’ve configured enough to sign-in to your Edge Service application, but it won’t be able to communicate with the downstream <code class="highlighter-rouge">beer-catalog-service</code>.</p>

<h2 id="add-spring-security-oauth-to-the-beer-catalog-service">Add Spring Security OAuth to the Beer Catalog Service</h2>

<p>In <code class="highlighter-rouge">beer-catalog-service/pom.xml</code>, add the same dependencies you added to the Edge Service, as well as one for Thymeleaf.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>Add the same properties to <code class="highlighter-rouge">beer-catalog-service/src/main/resources/application.properties</code>.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">security.oauth2.client.client-id</span><span class="p">=</span><span class="s">{yourClientId}</span>
<span class="py">security.oauth2.client.client-secret</span><span class="p">=</span><span class="s">{yourClientSecret}</span>
<span class="py">security.oauth2.client.access-token-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/token</span>
<span class="py">security.oauth2.client.user-authorization-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/authorize</span>
<span class="py">security.oauth2.client.scope</span><span class="p">=</span><span class="s">openid profile email</span>
<span class="py">security.oauth2.resource.filter-order</span><span class="p">=</span><span class="s">3</span>
<span class="py">security.oauth2.resource.user-info-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/userinfo</span>
<span class="py">security.oauth2.resource.token-info-uri</span><span class="p">=</span><span class="s"><span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default/v1/introspect</span>
<span class="py">security.oauth2.resource.prefer-token-info</span><span class="p">=</span><span class="s">false</span>
</code></pre></div></div>

<p><strong>TIP:</strong> An alternative to adding these properties is to use environment variables. For example, <code class="highlighter-rouge">SECURITY_OAUTH2_CLIENT_CLIENT_ID</code> would be the environment variable to specify <code class="highlighter-rouge">security.oauth2.client.client-id</code>. Using environment variables would allow you to change the settings for both apps from one location.</p>

<p>Create a <code class="highlighter-rouge">HomeController</code> in <code class="highlighter-rouge">beer-catalog-service/src/main/java/com/example/beercatalogservice/HomeController.java</code> to render the user’s information so you can verify authentication is working.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beercatalogservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.OAuth2Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.Principal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/home"</span><span class="o">)</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">howdy</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="o">(</span><span class="n">OAuth2Authentication</span><span class="o">)</span> <span class="n">principal</span><span class="o">;</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">().</span><span class="na">getDetails</span><span class="o">();</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"home"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Create a <code class="highlighter-rouge">home.html</code> template in <code class="highlighter-rouge">beer-catalog-service/src/main/resources/templates/home.html</code> and populate it with the following code.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">th</span> <span class="p">{</span>
            <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">td</span> <span class="p">{</span>
            <span class="nl">white-space</span><span class="p">:</span> <span class="nb">nowrap</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">td</span><span class="nd">:first-child</span> <span class="p">{</span>
            <span class="nl">font-family</span><span class="p">:</span> <span class="s1">"Courier"</span><span class="p">,</span> <span class="nb">monospace</span><span class="p">;</span>
            <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.9em</span><span class="p">;</span>
            <span class="nl">color</span><span class="p">:</span> <span class="m">#343434</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Hello<span class="nt">&lt;span</span> <span class="na">th:if=</span><span class="s">"${user}"</span> <span class="na">th:text=</span><span class="s">"' ' + ${user.name}"</span><span class="nt">&gt;</span> Joe<span class="nt">&lt;/span&gt;</span>!<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">th:unless=</span><span class="s">"${user}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/login}"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">th:if=</span><span class="s">"${user}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"logoutForm"</span> <span class="na">th:action=</span><span class="s">"@{/logout}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Logout"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;h2&gt;</span>User Properties<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Value<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>sub<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.sub}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>name<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.name}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>given_name<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.given_name}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>family_name<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.family_name}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>preferred_username<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.preferred_username}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>email<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.email}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>roles<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.roles}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Create a <code class="highlighter-rouge">ResourceServerConfig.java</code> class in the same package as <code class="highlighter-rouge">HomeController</code>. This class configures Spring Security so it secures all endpoints, except those accessed with an <code class="highlighter-rouge">Authorization</code> header.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beercatalogservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.util.matcher.RequestHeaderRequestMatcher</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableResourceServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="n">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">requestMatcher</span><span class="o">(</span><span class="k">new</span> <span class="n">RequestHeaderRequestMatcher</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">fullyAuthenticated</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="add-requestinterceptor-for-feign">Add RequestInterceptor for Feign</h3>

<p>The <code class="highlighter-rouge">@FeignClient</code> used to talk to <code class="highlighter-rouge">beer-catalog-service</code> is not aware of the <code class="highlighter-rouge">Authorization</code> header. To make it aware, create a <code class="highlighter-rouge">UserFeignClientInterceptor</code> class in the same directory as <code class="highlighter-rouge">EdgeServiceApplication</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">edgeservice</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">feign.RequestInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">feign.RequestTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserFeignClientInterceptor</span> <span class="kd">implements</span> <span class="n">RequestInterceptor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">AUTHORIZATION_HEADER</span> <span class="o">=</span> <span class="s">"Authorization"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">BEARER_TOKEN_TYPE</span> <span class="o">=</span> <span class="s">"Bearer"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SecurityContext</span> <span class="n">securityContext</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">securityContext</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getDetails</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">OAuth2AuthenticationDetails</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">OAuth2AuthenticationDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">OAuth2AuthenticationDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getDetails</span><span class="o">();</span>
            <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">AUTHORIZATION_HEADER</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s %s"</span><span class="o">,</span> <span class="n">BEARER_TOKEN_TYPE</span><span class="o">,</span> <span class="n">details</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Register it as a <code class="highlighter-rouge">@Bean</code> inside the <code class="highlighter-rouge">EdgeServiceApplication</code> class.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">feign.RequestInterceptor</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EdgeServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EdgeServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">RequestInterceptor</span> <span class="nf">getUserFeignClientInterceptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserFeignClientInterceptor</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In order to get Hystrix aware of the security context, you need to <a href="https://github.com/spring-cloud/spring-cloud-netflix/issues/1330">add two properties</a> to <code class="highlighter-rouge">edge-service/src/main/resources/application.properties</code>:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">feign.hystrix.enabled</span><span class="p">=</span><span class="s">true</span>
<span class="py">hystrix.shareSecurityContext</span><span class="p">=</span><span class="s">true</span>
</code></pre></div></div>

<h3 id="verify-secure-communication">Verify Secure Communication</h3>

<p>You can verify communication between the <code class="highlighter-rouge">edge-service</code> and <code class="highlighter-rouge">beer-catalog-service</code> works by starting all the Spring Boot applications. First, start <code class="highlighter-rouge">eureka-service</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>eureka-service
./mvnw spring-boot:run
</code></pre></div></div>

<p>In a new terminal window, start <code class="highlighter-rouge">beer-catalog-service</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>beer-catalog-service
./mvnw spring-boot:run
</code></pre></div></div>

<p>In another terminal window, start <code class="highlighter-rouge">edge-service</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>edge-service
./mvnw spring-boot:run
</code></pre></div></div>

<p>Open your browser and navigate to <code class="highlighter-rouge">http://localhost:8081/good-beers</code>. You should be redirected to your Okta domain and see a login page, prompting for your credentials.</p>

<p><img src="/assets/blog/microservices-spring-oauth/okta-login-c2f2108a2e4349144874bdae064804e58ca8220037a9a88146bb970bf72fa9e6.png" alt="Okta Sign-In Form" width="800" class="center-image" /></p>

<p>Enter the credentials you created your account with, and you’ll see a list of good beers as a result.</p>

<p><img src="/assets/blog/microservices-spring-oauth/good-beers-3303f97a1376e93dee12c8902d65833a52a56c5dc5dafde655150c63e266ff6c.png" alt="Good Beers" width="800" class="center-image" /></p>

<p>If you try to navigate to <code class="highlighter-rouge">http://localhost:8081/home</code>, it won’t work. This is because you need to add <a href="https://cloud.spring.io/spring-cloud-security/">Spring Cloud Security</a> to <code class="highlighter-rouge">edge-service/pom.xml</code> to relay the access token for the Zuul proxy.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>Without this dependency, requests to <code class="highlighter-rouge">/good-beers</code> will work (because Feign is configured), but <code class="highlighter-rouge">/home</code> will not (because Zuul needs Spring Cloud Security).</p>

<p>Restart your Edge Server application, navigate to <code class="highlighter-rouge">http://localhost:8081/home</code> and you’ll see your user details on the next page.</p>

<p><img src="/assets/blog/microservices-spring-oauth/user-details-c85e9aaaedaafe8469a93d7599c00a8b74ea765de2ad488c7b2cb5f50556ddd4.png" alt="Okta User Details" width="800" class="center-image" /></p>

<p><strong>NOTE:</strong> I was unable to get the logout button to work due to a CSRF error. I tried adding <code class="highlighter-rouge">security.enable-csrf=false</code> to <code class="highlighter-rouge">application.properties</code> in the Edge Service app, but it didn’t help. I sent an email to the Spring Security team asking if they had any advice.</p>

<h2 id="add-oktas-sign-in-widget-to-the-angular-client">Add Okta’s Sign-In Widget to the Angular Client</h2>

<p>To use Okta’s Sign-In Widget, you’ll need to modify your app in Okta to enable the <em>Implicit</em> grant type. Log in to your account, navigate to <strong>Applications</strong> &gt; <strong>Spring OAuth</strong> &gt; <strong>General</strong> tab and click <strong>Edit</strong>. Enable <strong>Implicit (Hybrid)</strong> under <strong>Allowed grant types</strong> and select both checkboxes below it. Add <code class="highlighter-rouge">http://localhost:4200</code> under <strong>Login redirect URIs</strong> and click <strong>Save</strong>.</p>

<p>For the Sign-In Widget to make requests to this application, you’ll also need to configure the client URL as a trusted origin. Click <strong>API</strong> &gt; <strong>Trusted Origins</strong> &gt; <strong>Add Origin</strong>. Enter <code class="highlighter-rouge">http://localhost:4200</code> as the <strong>Origin URL</strong> and select both checkboxes under it.</p>

<p>Open a terminal, navigate to <code class="highlighter-rouge">spring-boot-microservices-example/client</code>, and install the client’s dependencies using npm.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>client
npm install
</code></pre></div></div>

<p>Install <a href="https://developer.okta.com/code/javascript/okta_sign-in_widget">Okta’s Sign-In Widget</a> to make it possible to communicate with the secured server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install @okta/okta-signin-widget <span class="nt">--save</span>
</code></pre></div></div>

<p>Add the widget’s CSS to <code class="highlighter-rouge">client/src/styles.css</code>:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@import</span> <span class="s2">'~@okta/okta-signin-widget/dist/css/okta-sign-in.min.css'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">'~@okta/okta-signin-widget/dist/css/okta-theme.css'</span><span class="p">;</span>
</code></pre></div></div>

<p>Create <code class="highlighter-rouge">client/src/app/shared/okta/okta.service.ts</code> and use it to configure the widget to talk to your Okta tenant. Make sure to replace <code class="highlighter-rouge">{yourOktaDomain}</code> and <code class="highlighter-rouge">{clientId}</code> in the code below.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">OktaSignIn</span> <span class="k">from</span> <span class="s1">'@okta/okta-signin-widget'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OktaService</span> <span class="p">{</span>
  <span class="nx">widget</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
      <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'<span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>'</span><span class="p">,</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="s1">'{yourClientId}'</span><span class="p">,</span>
      <span class="na">authParams</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">issuer</span><span class="p">:</span> <span class="s1">'default'</span><span class="p">,</span>
        <span class="na">responseType</span><span class="p">:</span> <span class="p">[</span><span class="s1">'id_token'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">],</span>
        <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'openid'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'profile'</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">getWidget</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">getIdToken</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'idToken'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">getAccessToken</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add <code class="highlighter-rouge">OktaService</code> as a provider to <code class="highlighter-rouge">client/src/app/app.module.ts</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">OktaService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">OktaService</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Modify <code class="highlighter-rouge">client/src/app/shared/beer/beer.service.ts</code> to read the access token and set it in an <code class="highlighter-rouge">Authorization</code> header when it exists.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClient</span><span class="p">,</span> <span class="nx">HttpHeaders</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OktaService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../okta/okta.service'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">BeerService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpClient</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">oktaService</span><span class="p">:</span> <span class="nx">OktaService</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">getAll</span><span class="p">():</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">HttpHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HttpHeaders</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">())</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">();</span>
      <span class="c1">// headers is immutable, so re-assign</span>
      <span class="nx">headers</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">tokenType</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:8081/good-beers'</span><span class="p">,</span> <span class="p">{</span><span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Modify <code class="highlighter-rouge">app.component.html</code> to add a placeholder for the widget and a section to show the user’s name and a logout button.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;mat-toolbar</span> <span class="na">color=</span><span class="s">"primary"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span&gt;</span>Welcome to {{title}}!<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/mat-toolbar&gt;</span>

<span class="c">&lt;!-- Container to inject the Sign-In Widget --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"okta-signin-container"</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"user"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>
    Welcome {{user?.name}}!
  <span class="nt">&lt;/h2&gt;</span>

  <span class="nt">&lt;button</span> <span class="na">mat-raised-button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">logout</span><span class="err">()"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>

  <span class="nt">&lt;app-beer-list&gt;&lt;/app-beer-list&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>You’ll notice the <code class="highlighter-rouge">user</code> variable in the HTML. To resolve this, you need to change your <code class="highlighter-rouge">client/src/app/app.component.ts</code> so it renders the Sign-In Widget. Angular’s <code class="highlighter-rouge">ChangeDetectorRef</code> is used to notify Angular when things have changed and rendering needs to process updated variables.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ChangeDetectorRef</span><span class="p">,</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OktaService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-root'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./app.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./app.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'app'</span><span class="p">;</span>
  <span class="nx">user</span><span class="p">;</span>
  <span class="nx">signIn</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">oktaService</span><span class="p">:</span> <span class="nx">OktaService</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">changeDetectorRef</span><span class="p">:</span> <span class="nx">ChangeDetectorRef</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span> <span class="o">=</span> <span class="nx">oktaService</span><span class="p">.</span><span class="nx">getWidget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">showLogin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span> <span class="s1">'#okta-signin-container'</span><span class="p">},</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">'SUCCESS'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">token</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">idToken</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'idToken'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">changeDetectorRef</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">getUser</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">preferred_username</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="kd">get</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'INACTIVE'</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">getIdToken</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">changeDetectorRef</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">signOut</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">changeDetectorRef</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order for the <code class="highlighter-rouge">BeerListComponent</code> (at <code class="highlighter-rouge">src/app/beer-list/beer-list.component.ts</code>) to detect that you’ve logged in, you need to use add a constructor dependency on <code class="highlighter-rouge">ChangeDetectorRef</code> and invoke its <code class="highlighter-rouge">detectChanges()</code> method when you set the <code class="highlighter-rouge">giphyUrl</code> property on each <code class="highlighter-rouge">beer</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ChangeDetectorRef</span><span class="p">,</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BeerService</span><span class="p">,</span> <span class="nx">GiphyService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../shared'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-beer-list'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./beer-list.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./beer-list.component.css'</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">BeerService</span><span class="p">,</span> <span class="nx">GiphyService</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">BeerListComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nl">beers</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">beerService</span><span class="p">:</span> <span class="nx">BeerService</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">giphyService</span><span class="p">:</span> <span class="nx">GiphyService</span><span class="p">,</span>
              <span class="kr">private</span> <span class="nx">changeDetectorRef</span><span class="p">:</span> <span class="nx">ChangeDetectorRef</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">beerService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span>
      <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beers</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">beer</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">beers</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">giphyService</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">beer</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">url</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">beer</span><span class="p">.</span><span class="nx">giphyUrl</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">changeDetectorRef</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="verify-authentication-works">Verify Authentication Works</h3>

<p>Start the client by opening a terminal, navigating to the <code class="highlighter-rouge">client</code> directory, then running <code class="highlighter-rouge">npm start</code>. Open your browser to <code class="highlighter-rouge">http://localhost:4200</code>, and you should see a login form like the following.</p>

<p><img src="/assets/blog/microservices-spring-secure/angular-login-8caa17d0db5a326717d0dd90a2f877ff767884bea9afe74237675f6ab7a561c4.png" alt="Angular Login" width="800" class="center-image" /></p>

<p>If you want to adjust the style of the form, so it isn’t right up against the top toolbar, add the following to <code class="highlighter-rouge">styles.css</code>.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#okta-signin-container</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">25px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/blog/microservices-spring-secure/angular-login-top-margin-a86bcb3e9cc14f049551573c431006a4515f93837c74106c609135a9376aa3e3.png" alt="Angular Login Styled" width="800" class="center-image" /></p>

<p>You should be able to log in, see a welcome message, as well as a logout button. However, you won’t see a beer list because of the following error in your console.</p>

<pre color="red">
Failed to load http://localhost:8081/good-beers: Response for preflight is invalid (redirect)
</pre>

<p>This happens because Spring Security doesn’t recognize the <code class="highlighter-rouge">@CrossOrigin</code> annotation on the <code class="highlighter-rouge">/good-beers</code> endpoint. To fix this, add a <code class="highlighter-rouge">simpleCorsFilter</code> to <code class="highlighter-rouge">EdgeServiceApplication</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.boot.web.servlet.FilterRegistrationBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.Ordered</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.cors.CorsConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.cors.UrlBasedCorsConfigurationSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.filter.CorsFilter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EdgeServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EdgeServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">RequestInterceptor</span> <span class="nf">getUserFeignClientInterceptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserFeignClientInterceptor</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">FilterRegistrationBean</span> <span class="nf">simpleCorsFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UrlBasedCorsConfigurationSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UrlBasedCorsConfigurationSource</span><span class="o">();</span>
        <span class="n">CorsConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CorsConfiguration</span><span class="o">();</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setAllowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setAllowedOrigins</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">"*"</span><span class="o">));</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setAllowedMethods</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">"*"</span><span class="o">));</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setAllowedHeaders</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="s">"*"</span><span class="o">));</span>
        <span class="n">source</span><span class="o">.</span><span class="na">registerCorsConfiguration</span><span class="o">(</span><span class="s">"/**"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
        <span class="n">FilterRegistrationBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilterRegistrationBean</span><span class="o">(</span><span class="k">new</span> <span class="n">CorsFilter</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Restart the Edge Service application and try again. This time you should have great success!</p>

<p><img src="/assets/blog/microservices-spring-secure/angular-welcome-b735b67b696573dad476bc876cc5ec1f6470d02fb6567c57a3f1bd6278ca30ee.png" alt="Angular Welcome" width="800" class="center-image" /></p>

<p><strong>NOTE:</strong> You should change the allowed origins from <code class="highlighter-rouge">*</code> to your client’s URLs if you’re using this configuration in production.</p>

<h3 id="deploy-to-cloud-foundry">Deploy to Cloud Foundry</h3>

<p>To deploy everything on Cloud Foundry with <a href="http://run.pivotal.io/">Pivotal Web Services</a>, you’ll need to create an account, download/install the <a href="https://github.com/cloudfoundry/cli#downloads">Cloud Foundry CLI</a>, and sign-in (using <code class="highlighter-rouge">cf login -a api.run.pivotal.io</code>).</p>

<p>There are quite a few steps involved to deploy all the services and the Angular client for production. For that reason, I wrote a <a href="https://github.com/oktadeveloper/spring-boot-microservices-example/blob/oauth/deploy.sh"><code class="highlighter-rouge">deploy.sh</code></a> script that automates everything.</p>

<p><strong>NOTE:</strong> After this script finishes, you’ll have to add the URL for the client to your Okta app as a <strong>Login redirect URI</strong>. You’ll also need to add it as an origin under <strong>API</strong> &gt; <strong>Trusted Origins</strong>.</p>

<p><strong>TIP:</strong> If you receive an error stating that you’re using too much memory, you may have to upgrade your Cloud Foundry subscription.</p>

<h2 id="learn-more-about-spring-boot-oauth-20-and-microservices">Learn More about Spring Boot, OAuth 2.0, and Microservices</h2>

<p>This article showed you how to use Spring Security, OAuth, and Okta secure a microservices architecture. With Zuul, Feign, and Spring Cloud Security, you can ensure your backend services communicate securely.</p>

<p>The source code for this tutorial is <a href="https://github.com/oktadeveloper/spring-boot-microservices-example/">available on GitHub</a>, in the <a href="https://github.com/oktadeveloper/spring-boot-microservices-example/tree/oauth">“oauth” branch</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/oktadeveloper/spring-boot-microservices-example.git
git checkout oauth
</code></pre></div></div>

<p>This tutorial showed you how to add security to a previous tutorial, <a href="/blog/2017/06/15/build-microservices-architecture-spring-boot">Build a Microservices Architecture for Microbrews with Spring Boot</a>.</p>

<p>If you’re interested in learning about the future of Spring Security and OAuth 2.0, see <a href="https://spring.io/blog/2018/01/30/next-generation-oauth-2-0-support-with-spring-security">Next Generation OAuth 2.0 Support with Spring Security</a> by our good friend <a href="https://twitter.com/joe_grandja">Joe Grandja</a> of the Spring Security Team.</p>

<p>Also, JHipster uses this same setup with its <a href="http://www.jhipster.tech/security/#-oauth2-and-openid-connect">OAuth support</a>. I hope to write a post soon that demonstrates how to create a microservices architecture with JHipster and OAuth. In the meantime, you can see how to <a href="/blog/2018/01/30/jhipster-ionic-with-oidc-authentication">Use Ionic for JHipster to Create Mobile Apps with OIDC Authentication</a>.</p>

<p>Learn more about Okta and its APIs at <a href="https://developer.okta.com/product/">developer.okta.com/product</a>. If you have questions about this tutorial, please leave a comment below or hit me up on Twitter <a href="https://twitter.com/mraible">@mraible</a>.</p>


    </div>

    
    <div id="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_title = "Secure a Spring Microservices Architecture with Spring Security and OAuth 2.0";
            var disqus_url = 'https://developer.okta.com/blog/2018/02/13/secure-spring-microservices-with-oauth';

            (function () {
                var dsq = document.createElement('script');
                dsq.async = true;
                dsq.type = 'text/javascript';
                dsq.src = '//oktadevblog.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>
              Please enable JavaScript to view the
              <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus</a>.
         </noscript>
    </div>
    
</article>

		
</section>

		
	</div>
	<footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">
                <a href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <div class="Logo">
                        <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    </div>
                    <p>Visit okta.com</p>
                </a>
            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">
                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/change-log/">Change Log</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="https://developer.okta.com/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="https://developer.okta.com/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="https://developer.okta.com/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-aa397c892d9083236c5cb20732dde679021b9236c8142ce78177b8b184567a02.js"></script>
    <script type="text/javascript" src="/assets/myOkta-911cbafbbe079b7a5522d9cbe15bd2a5f44e1582531e88393934bec69f97696b.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
