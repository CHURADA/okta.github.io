<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager

      // Start Heap Analytics
      window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
      heap.load("3356162945");
      // End Heap Analytics
    }
  </script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="Use OpenID Connect for Authorization in Your ASP.NET MVC Framework 4.x App | Okta Developer">
  <meta class="swiftype" name="summary" data-type="string" content="This is a quick tutorial demonstrating how to add authorization to an ASP.NET MVC Application using OpenID Connect and Okta." />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-914cad2dd6d069302444327ce911da52da68a3c68755f66cf5a4e92b9a38f3eb.css">
  
  
  <title>Use OpenID Connect for Authorization in Your ASP.NET MVC Framework 4.x App | Okta Developer</title>
  <meta name="description" content="This is a quick tutorial demonstrating how to add authorization to an ASP.NET MVC Application using OpenID Connect and Okta.">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#21313a">
  <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first expanded">
          <a href="https://developer.okta.com/product/">Product</a>
          <ul class="menu">
            <li class="first leaf"><a href="https://developer.okta.com/product/">Overview</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authentication/">Authentication</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authorization/">Authorization</a></li>
            <li class="last leaf"><a href="https://developer.okta.com/product/user-management/">User Management</a></li>
          </ul>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/leebrandt" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/leebrandt" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="http://leebrandt.me" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">

    <header class="BlogPost-header">

        <time class="BlogPost-date" datetime="2018-04-18">April 18, 2018</time>

        <h1 class="BlogPost-title">
            
            Use OpenID Connect for Authorization in Your ASP.NET MVC Framework 4.x App
            
        </h1>

        <div class="BlogPost-attribution">
            
            <img src="/assets/avatar-leebrandt-23a647548f26433d031856dcef1df5204763b94283cd68c397d816a61363a94d.jpg" alt="avatar-leebrandt.jpg" class="BlogPost-avatar">
            
            <span class="BlogPost-author">Lee Brandt</span>
        </div>

    </header>

    <div class="BlogPost-content">
        
	<p>A common practice in web applications is to have a restricted area for registered users, and perhaps another for administrators. Whether this restricted access area is premium content, or simply the order history for your e-commerce site’s users, it’s important that it be properly secured. OpenID Connect (OIDC) makes it easy, but it can be tricky to set up in ASP.NET MVC framework. In this post, I’ll show you how to create groups and use the authorization framework that comes with ASP.NET.</p>

<h2 id="set-up-the-base-aspnet-mvc-4x-application">Set Up the Base ASP.NET MVC 4.x Application</h2>

<p>For the base application, start by downloading our <a href="https://github.com/oktadeveloper/okta-aspnet-mvc-example">ASP.NET MVC example from GitHub</a>. You’ll also need to set up your application in Okta. Start by creating a <a href="https://developer.okta.com/signup/">forever-free developer account</a>, or logging in if you already have one. Once you’re at the dashboard in the Okta developer console, create an application with the following settings:</p>

<ul>
  <li>Application type: Web</li>
  <li>Allowed grant types: Authorization Code, Implicit (Hybrid) - Allow ID Token</li>
  <li>Login redirect URI: <code class="highlighter-rouge">http://localhost:8080/authorization-code/callback</code></li>
  <li>Logout redirect URI: <code class="highlighter-rouge">http://localhost:8080/Account/PostLogout</code></li>
</ul>

<p>Then open the Web.config file and add these keys to the <code class="highlighter-rouge">&lt;appSettings&gt;</code> section:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- 1. Replace these values with your Okta configuration --&gt;</span>
<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"okta:ClientId"</span> <span class="na">value=</span><span class="s">"{clientId}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"okta:ClientSecret"</span> <span class="na">value=</span><span class="s">"{clientSecret}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"okta:OrgUri"</span> <span class="na">value=</span><span class="s">"<span class="okta-preview-domain"><span class="okta-preview-domain">https://{yourOktaDomain}.com</span></span>/oauth2/default"</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- 2. Update the Okta application with these values --&gt;</span>
<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"okta:RedirectUri"</span> <span class="na">value=</span><span class="s">"http://localhost:8080/authorization-code/callback"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"okta:PostLogoutRedirectUri"</span> <span class="na">value=</span><span class="s">"http://localhost:8080/Account/PostLogout"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<h2 id="add-groups-to-the-id-token">Add Groups to the ID Token</h2>

<p>First, add two groups to your new application: <em>Users</em> and <em>Admins</em>. From the dashboard, hover over the <strong>Users</strong> menu item and from the drop-down menu choose <strong>Groups</strong>. On the groups screen, click <strong>Add Group</strong>.</p>

<p><img src="/assets/blog/aspnet-authz/CreateGroupScreenshot-756757ba9bd65152afd4f9f13b2bccee798894b3bdd6b8befbebb0bb9210e4a8.png" alt="Create Groups Screen" width="600" class="center-image" /></p>

<p>To add users, click on the <strong>Users</strong> menu item. Click on <strong>Add User</strong> and create two new users. The only required information is first name, last name, and email address. The interface will automatically set the username to the primary email.</p>

<p>Then make sure to select <strong>Set by Admin</strong> in the <strong>Password</strong> drop-down, set the password to something simple and then uncheck the <strong>User must change password on the first login</strong> checkbox. Finally, click the <strong>Save and Add Another</strong>, and add another user called <em>Jack Daniels</em> with the same settings.</p>

<p><img src="/assets/blog/aspnet-authz/CreateUserScreenshot-a4e1f2b50a9722d2ca84cc7ee526048156e9dbb34999952b5a70222ce5f69b72.png" alt="Create User Screen" width="600" class="center-image" /></p>

<p>Add Jim Beam to the <strong>Users</strong> group and add Jack Daniels to the Admin group. To do this, go back to the <strong>Groups</strong> page and select the group you want to add people to. Then, click <strong>Manage People</strong>. When you hover over each person in the listing of users that are not members on the left, there will be a green plus sign button. Click this button to add that person to the selected group.</p>

<p><img src="/assets/blog/aspnet-authz/AddUserToGroupScreenshot-acb3e85c6c45d93f4806401e164601720730df27ae5e6aff85605669467a1fb8.png" alt="Add User To Group Screen" width="600" class="center-image" /></p>

<p>Now you just need to add these groups to the token.</p>

<ul>
  <li>Hover over the <strong>API</strong> menu item and select <strong>Authorization Servers</strong>.</li>
  <li>Select the default authorization server (it was created for you when you created your Okta account).</li>
  <li>Choose the Claims tab, and click <strong>Add Claim</strong>.</li>
  <li>The name of the claim will be “groups”, 
Select <strong>ID Token</strong> and <strong>Always</strong> from the <strong>Include in token type</strong> setting.</li>
  <li>Choose <strong>Groups</strong> from the <strong>Value Type</strong> setting, and <strong>Regex</strong> from the <strong>Filter</strong> setting.</li>
  <li>In the text box type <code class="highlighter-rouge">.*</code>.</li>
  <li>Finally, make sure the <strong>Disable claim</strong> checkbox is unchecked and that the <strong>Any scope</strong> radio button is selected in the <strong>Include in</strong> setting.</li>
</ul>

<p><img src="/assets/blog/aspnet-authz/AddGroupsToTokenScreenshot-c78196f6d97cb7d76120047046bf9c59468fc758f001e08b175de017db8c58bf.png" alt="Add Groups to Token Screen" width="600" class="center-image" /></p>

<h2 id="map-the-openid-connect-groups-to-roles">Map the OpenID Connect Groups to Roles</h2>

<p>Once you’ve got groups in the token, you’ll need to map those to roles, since the authorization attributes in ASP.NET MVC uses roles to restrict access. To do this, open the <code class="highlighter-rouge">Startup.cs</code> file, and add in the <code class="highlighter-rouge">ConfigureAuth</code> method, there’s a section of the code that sets up the OpenID Connect authentication called <code class="highlighter-rouge">UseOpenIdConnectAuthentication</code> that takes an argument of type <code class="highlighter-rouge">OpenIdConnectAuthenticationOptions</code>. Inside the <code class="highlighter-rouge">Notification</code> property, there is a function for <code class="highlighter-rouge">AuthorizationCodeReceived</code>. Below the <code class="highlighter-rouge">nameClaim</code>, add a loop to go through each of the groups in the token and a <code class="highlighter-rouge">RoleType</code> claim to the <code class="highlighter-rouge">identity</code> object.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="k">group</span> <span class="k">in</span> <span class="n">userInfoResponse</span><span class="p">.</span><span class="n">Claims</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="s">"groups"</span><span class="p">))</span>
<span class="p">{</span>
        <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="p">,</span> <span class="k">group</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Now you can use those roles in the authorize attribute.</p>

<h2 id="add-restricted-mvc-routes">Add Restricted MVC Routes</h2>

<p>To the <code class="highlighter-rouge">AccountController</code>, add some new restricted routes: one for each group.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// previous controller actions removed for brevity</span>
<span class="na">[Authorize(Roles = "Enthusiasts")]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Enthusiast</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">View</span><span class="p">();</span>

<span class="na">[Authorize(Roles = "Admin")]</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Admin</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">View</span><span class="p">();</span>
</code></pre></div></div>

<p>Now the authorization should work, but there is one problem. If a user is logged in but does not belong to the correct group, the default <code class="highlighter-rouge">AuthorizeAttribute</code> will attempt to redirect the user to the login screen for authentication. The login screen will determine that the user is already authenticated and will redirect back to the <code class="highlighter-rouge">redirectUri</code> with the token. The <code class="highlighter-rouge">redirectUri</code> will rebuild the <code class="highlighter-rouge">ClaimsPrincipal</code> and try to redirect the user back to the URL they originally requested. The <code class="highlighter-rouge">AuthorizeAttribute</code> will run again and begin the cycle all over again.</p>

<h2 id="create-a-custom-aspnet-mvc-attribute">Create a Custom ASP.NET MVC Attribute</h2>

<p>To avoid this problem, you’ll need to rewire the default behavior of the default <code class="highlighter-rouge">AuthorizeAttribute</code> by creating a new attribute, and overriding the default behavior when the user is unauthorized. In the main project folder (where the controller folder is), create a new folder called <strong>Helpers</strong>. Inside that folder create a new C# class called <code class="highlighter-rouge">OktaAuthorize</code>. Change the class so that it inherits from <code class="highlighter-rouge">AuthorizeAttribute</code> and override the <code class="highlighter-rouge">HandleUnauthorizedRequest</code> method like below.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">HandleUnauthorizedRequest</span><span class="p">(</span><span class="n">AuthorizationContext</span> <span class="n">filterContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">filterContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">HandleUnauthorizedRequest</span><span class="p">(</span><span class="n">filterContext</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">filterContext</span><span class="p">.</span><span class="n">Result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RedirectToRouteResult</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">RouteValueDictionary</span><span class="p">(</span>
                <span class="k">new</span>
                <span class="p">{</span>
                    <span class="n">controller</span> <span class="p">=</span> <span class="s">"Error"</span><span class="p">,</span>
                    <span class="n">action</span> <span class="p">=</span> <span class="s">"AccessDenied"</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above code simply checks if the user is logged in. If they are aren’t, the <code class="highlighter-rouge">HandleUnauthorizedRequest()</code> can handle the request just fine. If they are logged in, it redirects to the error controller’s <code class="highlighter-rouge">AccessDenied</code> action.</p>

<p>Next, you’ll need to create that <code class="highlighter-rouge">AccessDenied</code> action in the <code class="highlighter-rouge">ErrorController</code> so the complete controller looks like below.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ErrorController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="c1">// GET: Error</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">AccessDenied</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lastly, just create a simple <code class="highlighter-rouge">AccessDenied</code> view for the controller.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@</span><span class="p">{</span>
    <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">"AccessDenied"</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">AccessDenied</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>You should now be able to run the application and see that if you’re logged in with the Jim Beam user, when you try to navigate to the <code class="highlighter-rouge">account/admin</code> action, you get redirected to the <code class="highlighter-rouge">AccessDenied</code> page instead of the “unauthorized loop” that you’d get with the default <code class="highlighter-rouge">AuthorizeAttribute</code>.</p>

<p><img src="/assets/blog/aspnet-authz/ApplicationRunningScreenshot-6f255c053d4949560c83dce4ef04c00ac08ba9203822e836c93f3217ddcfcfd7.png" alt="Application Running" width="800" class="center-image" /></p>

<h2 id="learn-more-about-aspnet-and-okta">Learn More About ASP.NET and Okta</h2>

<p>If you’d like to learn more about how Okta can ease identity management for your applications, check out <a href="https://developer.okta.com/documentation/">Okta’s product documentation</a>. Interested in learning more about ASP.NET? Check out these resources from our blog::</p>
<ul>
  <li><a href="https://developer.okta.com/blog/2018/02/01/secure-aspnetcore-webapi-token-auth">How to Secure Your .NET Web API with Token Authentication</a></li>
  <li><a href="https://developer.okta.com/blog/2018/01/31/build-secure-todo-app-vuejs-aspnetcore">Build a Secure To-Do App with Vue, ASP.NET Core, and Okta</a></li>
  <li><a href="https://developer.okta.com/blog/2018/01/10/build-app-for-ios-android-with-xamarin">Build an App for iOS and Android with Xamarin</a></li>
</ul>

<p>And as always, we’d love to hear from you. Hit us up in the comments, or on Twitter <a href="https://twitter.com/OktaDev">@oktadev</a>.</p>


    </div>

    
    <div id="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_title = "Use OpenID Connect for Authorization in Your ASP.NET MVC Framework 4.x App";
            var disqus_url = 'https://developer.okta.com/blog/2018/04/18/authorization-in-your-aspnet-mvc-4-application';

            (function () {
                var dsq = document.createElement('script');
                dsq.async = true;
                dsq.type = 'text/javascript';
                dsq.src = '//oktadevblog.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>
              Please enable JavaScript to view the
              <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus</a>.
         </noscript>
    </div>
    
</article>

		
</section>

		
	</div>
	<footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">
                <a href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <div class="Logo">
                        <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    </div>
                    <p>Visit okta.com</p>
                </a>
            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">
                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/change-log/">Change Log</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="https://developer.okta.com/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="https://developer.okta.com/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="https://developer.okta.com/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-aa397c892d9083236c5cb20732dde679021b9236c8142ce78177b8b184567a02.js"></script>
    <script type="text/javascript" src="/assets/myOkta-911cbafbbe079b7a5522d9cbe15bd2a5f44e1582531e88393934bec69f97696b.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
