<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager

      // Start Heap Analytics
      window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
      heap.load("3356162945");
      // End Heap Analytics
    }
  </script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="Secure Server-to-Server Communication with Spring Boot and OAuth 2.0 | Okta Developer">
  <meta class="swiftype" name="summary" data-type="string" content="Most OAuth 2.0 guides are focused around the co..." />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-914cad2dd6d069302444327ce911da52da68a3c68755f66cf5a4e92b9a38f3eb.css">
  
  
  <title>Secure Server-to-Server Communication with Spring Boot and OAuth 2.0 | Okta Developer</title>
  <meta name="description" content="Most OAuth 2.0 guides are focused around the co...">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#21313a">
  <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first expanded">
          <a href="https://developer.okta.com/product/">Product</a>
          <ul class="menu">
            <li class="first leaf"><a href="https://developer.okta.com/product/">Overview</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authentication/">Authentication</a></li>
            <li class="leaf"><a href="https://developer.okta.com/product/authorization/">Authorization</a></li>
            <li class="last leaf"><a href="https://developer.okta.com/product/user-management/">User Management</a></li>
          </ul>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/bdemers" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/briandemers" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="https://www.linkedin.com/in/bdemers/" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">

    <header class="BlogPost-header">

        <time class="BlogPost-date" datetime="2018-04-02">April 2, 2018</time>

        <h1 class="BlogPost-title">
            
            Secure Server-to-Server Communication with Spring Boot and OAuth 2.0
            
        </h1>

        <div class="BlogPost-attribution">
            
            <img src="/assets/avatar-bdemers-636ca7ee331b80687c5c7c7040952915b86ea81adbf4a61c2e5902d48e1f23c8.jpg" alt="avatar-bdemers.jpg" class="BlogPost-avatar">
            
            <span class="BlogPost-author">Brian Demers</span>
        </div>

    </header>

    <div class="BlogPost-content">
        
	<p>Most OAuth 2.0 guides are focused around the context of a user, i.e., login to an application using Google, Github, Okta, etc., then do something on behalf of that user. While useful, these guides ignore server-to-server communication where there is no user and you only have one service connecting to another one.</p>

<p>The OAuth 2 client credentials grant type is exclusively used for scenarios in which no user exists (CRON jobs, scheduled tasks, other data workloads, etc.). This flow is less <em>showy</em> than other OAuth flows as there is no end user or browser to deal with, but is far easier to understand than the more complicated user-centric OAuth 2.0 grant types.</p>

<h2 id="oauth-20-client-credentials-grant">OAuth 2.0 Client Credentials Grant</h2>

<p>The goal of the <a href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/">client credentials</a> grant is to allow two machines to communicate securely. In this grant type you have a client (think of this as your application) making API requests to another service (this is your resource server).</p>

<p>To help illustrate why this flow is important, let’s take a step back and talk about what we did before OAuth 2.0.</p>

<p><strong>NOTE</strong>: If you’re an OAuth pro, you can skip ahead to the <a href="#lets-build-an-oauth-20-client-credentials-app">code examples below</a> or check out the example on <a href="https://github.com/oktadeveloper/spring-boot-client-credentials-example">GitHub</a>.</p>

<p>Before OAuth 2.0 the way developers handled server-to-server authentication was with HTTP Basic Auth. Essentially what this boiled down to was that a developer would send over a server’s unique username and password (often referred to as an ID and secret) on each request. The API service would then validate this username and password on every request by connecting to a user store (database, LDAP, etc.) in order to validate the credentials.</p>

<p><img src="/assets/blog/client-creds-with-spring-boot/password-sequence-425e0b5f98c58bdf5b977262eaa422c275c63ec3b2d4c4c670fd866d90c0f69b.png" alt="Password sequence diagram" width="800" class="center-image" /></p>

<p>This approach has a few drawbacks and exposure points:</p>

<ul>
  <li>Each application in the diagram above handles the username and password</li>
  <li>A second username and password might be needed to connect to user store</li>
  <li>The same username and password is used for each request</li>
</ul>

<p>There are various ways to help mitigate these risks, but that’s out of scope in this post.</p>

<p>The OAuth 2.0 client credentials grant was created to help solve for the problems that HTTP Basic Auth had. While the client still uses a username and password (called the <code class="highlighter-rouge">client_id</code> and <code class="highlighter-rouge">client_secret</code>), instead of sending them directly to the API service on each request they are instead exchanged for a token via an <a href="https://tools.ietf.org/html/rfc6749#section-1.1">authorization server</a>.</p>

<p><img src="/assets/blog/client-creds-with-spring-boot/client-creds-7fee4525b7b3e50e56ab635711468599b17126e8a8393986c572fffc2c4883b3.png" alt="Client credentials sequence diagram" width="800" class="center-image" /></p>

<p>The authorization server returns a temporary access token (which is used until it expires). The client then uses this access token when communicating with the resource server which means that your client’s most sensitive data (the id and secret) are only shared over the network once every expiration period, dramatically reducing the likelihood of compromise. Once the resource server receives the incoming request with the access token it will then validate the token with by talking to the authorization server.</p>

<p>I’ll talk about a couple of ways to reduce the number of network calls further at the end of this post, but first, onto an example!</p>

<h2 id="lets-build-an-oauth-20-client-credentials-app">Let’s Build an OAuth 2.0 Client Credentials App!</h2>

<p>Enough talk, let’s do something! I’m going to show you  <em>how</em> to implement the client credentials grant type with Spring using two applications: a <code class="highlighter-rouge">client</code> and <code class="highlighter-rouge">server</code>.  The server will have a single endpoint which returns a “message of the day.”  The client will be a simple command line application; you could easily replace this with a backend web application, CRON job, or any other backend script.</p>

<h3 id="set-up-your-authorization-server">Set Up Your Authorization Server</h3>

<p>To keep things simple, you’ll use Okta to create an OAuth 2.0 authorization server. This will handle all of the client credentials grant stuff mentioned above. Do you need to use Okta? Not at all! You can use any OAuth 2.0 compatible server you want — but because our service is free and simple to use, it speeds this process up.</p>

<p>If you don’t already have a free developer account, head over to <a href="/">developer.okta.com</a> and click sign up. When that’s done you’ll have two pieces of information, your Okta base URL which looks something like: <code class="highlighter-rouge">dev-123456.oktapreview.com</code>, and an email with instructions on how to activate your account.</p>

<p>After activating your account, while you are still in the Okta Developer Console, you then need to create an application and a custom OAuth scope. The application will give you a client ID and secret, while the custom scope will restrict your access token to this example.</p>

<p>Click the <strong>Applications</strong> menu item, then <strong>Add Application</strong>, then <strong>Service</strong> -&gt; <strong>Next</strong>. Change the name to whatever you want (I’m going to use “My MOD App”), then click <strong>Done</strong>.</p>

<p>You will need the <strong>Client ID</strong> and <strong>Client secret</strong> values for the next steps.</p>

<p>Next, create a <a href="https://www.oauth.com/oauth2-servers/scope/defining-scopes/">custom scope</a> for your application.</p>

<p>From the menu bar select <strong>API</strong> -&gt; <strong>Authorization Servers</strong>. Remember the <strong>Issuer URI</strong> value; you will need this for the next steps. Edit the authorization server by clicking on the edit pencil, then click <strong>Scopes</strong> -&gt; <strong>Add Scope</strong>.  Fill out the name field with <code class="highlighter-rouge">custom_mod</code> and press <strong>Create</strong>.</p>

<p><img src="/assets/blog/client-creds-with-spring-boot/custom-scope-eabddbbebd0c5229678116143bbdd49318cca8e261d50f6070b011055022c281.png" alt="Create a custom scope in Okta Developer Console" width="800" class="center-image" /></p>

<p>Onto the fun stuff!</p>
<h3 id="create-a-resource-server">Create a Resource Server</h3>

<p>This resource server (aka: API service) is going to be overly simple and consist of a single <code class="highlighter-rouge">/mod</code> endpoint. Create a new project using the <a href="https://start.spring.io/">Spring Initializer</a> on the command line:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://start.spring.io/starter.tgz  <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">artifactId</span><span class="o">=</span>creds-example-server <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">dependencies</span><span class="o">=</span>security,web <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">language</span><span class="o">=</span>java <span class="se">\</span>
  <span class="nt">-d</span> <span class="nb">type</span><span class="o">=</span>maven-project <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">baseDir</span><span class="o">=</span>creds-example-server <span class="se">\</span>
| <span class="nb">tar</span> <span class="nt">-xzvf</span> -

<span class="c"># change into the new directory</span>
<span class="nb">cd </span>creds-example-server
</code></pre></div></div>

<p>You will also need to manually add one more dependency to your <code class="highlighter-rouge">pom.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p><strong>NOTE</strong>: I also renamed the <code class="highlighter-rouge">DemoApplication</code> to <code class="highlighter-rouge">ServerApplication</code> because we are going to create another application shortly.</p>

<p>Update <code class="highlighter-rouge">ServerApplication</code> to include the <code class="highlighter-rouge">@EnableResourceServer</code> annotation and add a simple REST controller:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableResourceServer</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ServerApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Allows for @PreAuthorize annotation processing.
     */</span>
    <span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GlobalSecurityConfiguration</span> <span class="kd">extends</span> <span class="n">GlobalMethodSecurityConfiguration</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">MethodSecurityExpressionHandler</span> <span class="nf">createExpressionHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">OAuth2MethodSecurityExpressionHandler</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RestController</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageOfTheDayController</span> <span class="o">{</span>
        <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/mod"</span><span class="o">)</span>
        <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"#oauth2.hasScope('custom_mod')"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessageOfTheDay</span><span class="o">(</span><span class="n">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"The message of the day is boring for user: "</span> <span class="o">+</span> <span class="n">principal</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now it’s time to configure the application! I renamed my <code class="highlighter-rouge">application.properties</code> file to <code class="highlighter-rouge">application.yml</code> and updated it to include:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
  <span class="na">oauth2</span><span class="pi">:</span>
    <span class="na">client</span><span class="pi">:</span>
      <span class="na">clientId</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">client-id-from-above</span><span class="pi">}</span>
      <span class="na">clientSecret</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">client-secret-from-above</span><span class="pi">}</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">tokenInfoUri</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">issuer-uri-from-above</span><span class="pi">}</span><span class="s">/v1/introspect</span>
</code></pre></div></div>

<p>That’s it: a few lines of code and a couple lines of config! Spring Boot will automatically handle the validation of the access tokens, all you need to worry about is your code.</p>

<p>Start it up and leave it running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./mvn spring-boot:run
</code></pre></div></div>

<p>You can try to access <code class="highlighter-rouge">http://localhost:8080/mod</code> if you want, it will respond with a, <code class="highlighter-rouge">HTTP 401 UNAUTHORIZED</code>.</p>
<h3 id="create-the-oauth-20-client">Create the OAuth 2.0 Client</h3>

<p>Next, you’re going to create a simple command line client (you could easily duplicate this logic in any type of application).</p>

<p>Open up a new terminal window and create a second application with the Spring Initializer:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://start.spring.io/starter.tgz  <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">artifactId</span><span class="o">=</span>creds-example-client <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">dependencies</span><span class="o">=</span>security <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">language</span><span class="o">=</span>java <span class="se">\</span>
  <span class="nt">-d</span> <span class="nb">type</span><span class="o">=</span>maven-project <span class="se">\</span>
  <span class="nt">-d</span> <span class="nv">baseDir</span><span class="o">=</span>creds-example-client <span class="se">\</span>
| <span class="nb">tar</span> <span class="nt">-xzvf</span> -

<span class="c"># change into the new directory</span>
<span class="nb">cd </span>creds-example-client
</code></pre></div></div>

<p>Same as before, add in the Spring OAuth 2.0 library as a dependency in your <code class="highlighter-rouge">pom.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>This time I’ll start by defining the configuration (again I renamed <code class="highlighter-rouge">application.properties</code> to <code class="highlighter-rouge">application.yml</code>):</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">example</span><span class="pi">:</span>
  <span class="na">baseUrl</span><span class="pi">:</span> <span class="s">http://localhost:8080</span>
  <span class="na">oauth2</span><span class="pi">:</span>
    <span class="na">client</span><span class="pi">:</span>
      <span class="na">grantType</span><span class="pi">:</span> <span class="s">client_credentials</span>
      <span class="na">clientId</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">client-id-from-above</span><span class="pi">}</span>
      <span class="na">clientSecret</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">client-secret-from-above</span><span class="pi">}</span>
      <span class="na">accessTokenUri</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">issuer-uri-from-above</span><span class="pi">}</span><span class="s">/v1/token</span>
      <span class="na">scope</span><span class="pi">:</span> <span class="s">custom_mod</span>
</code></pre></div></div>

<p>I’ve namespaced the configuration under <code class="highlighter-rouge">example</code> as you could be connecting to multiple servers.</p>

<p>I configured a few properties:</p>

<ul>
  <li><code class="highlighter-rouge">baseUrl</code> is the base URL of our example server</li>
  <li><code class="highlighter-rouge">grantType</code> defines the grant type for the connection</li>
  <li><code class="highlighter-rouge">clientId</code> and <code class="highlighter-rouge">clientSecret</code> are the same as above</li>
  <li><code class="highlighter-rouge">accessTokenUri</code> defines the URI used to get an access token</li>
  <li><code class="highlighter-rouge">scope</code> is the custom scope we created above</li>
</ul>

<p>Last up is our <code class="highlighter-rouge">ClientApplication</code> (renamed from <code class="highlighter-rouge">DemoApplication</code>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientApplication</span> <span class="kd">implements</span> <span class="n">CommandLineRunner</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ClientApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"#{ @environment['example.baseUrl'] }"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverBaseUrl</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ClientApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="s">"example.oauth2.client"</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="n">ClientCredentialsResourceDetails</span> <span class="nf">oAuthDetails</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ClientCredentialsResourceDetails</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">protected</span> <span class="n">RestTemplate</span> <span class="nf">restTemplate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OAuth2RestTemplate</span><span class="o">(</span><span class="n">oAuthDetails</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"MOD: {}"</span><span class="o">,</span> <span class="n">restTemplate</span><span class="o">().</span><span class="na">getForObject</span><span class="o">(</span><span class="n">serverBaseUrl</span> <span class="o">+</span> <span class="s">"/mod"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There are a few things I want to touch on:</p>

<ul>
  <li>The <code class="highlighter-rouge">CommandLineRunner</code> interface adds a <code class="highlighter-rouge">run</code> method, which is called automatically after initialization, the application exits after leaving this method</li>
  <li>I created a <code class="highlighter-rouge">ClientCredentialsResourceDetails</code> bean which is bound to my configuration properties: <code class="highlighter-rouge">example.oauth2.client</code></li>
  <li>I use an <code class="highlighter-rouge">OAuth2RestTemplate</code> in place of a standard <code class="highlighter-rouge">RestTemplate</code> this automatically manages all of the OAuth 2.0 access token exchange and sets the <code class="highlighter-rouge">Authentication: Bearer</code> header value.  Basically, it handles all of the OAuth detail so you don’t need to worry about any of them!</li>
</ul>

<p>Run the application with <code class="highlighter-rouge">./mvnw spring-boot:run</code> and you should see console output similar to:</p>

<pre><code class="language-txt">2018-03-20 12:56:10.058  INFO 15833 --- [main] c.e.c.ClientApplication: MOD: The message of the day is boring for user: 0oabcd12yz2EpHuis75s3
</code></pre>

<p>The client has successfully communicated with the server! Not bad, right? In just a few lines of code you were able to get an OAuth 2.0 authorization server setup and configured as well as create two Spring apps (one client and one server) which can now communicate securely using the OAuth 2.0 client credentials grant type!</p>

<p><strong>NOTE:</strong> if you see a <code class="highlighter-rouge">401</code> or <code class="highlighter-rouge">500</code> exception double check that your <code class="highlighter-rouge">application.yml</code> config files contain the correct information.</p>

<h2 id="extra-credit-reduce-the-number-of-calls-to-the-authorization-server">Extra Credit: Reduce the Number of Calls to the Authorization Server</h2>

<p>The second sequence diagram above seems more complicated than the first, even when factoring in the reuse of an access token. Access tokens are opaque, there is no spec behind them, and the format is left to the implementation of the authorization server.</p>

<p>At Okta we use signed JWTs which means you can <a href="/authentication-guide/tokens/validating-access-tokens">validate them locally</a> instead of making an additional request from the API service to the authorization server on each request.</p>

<p><img src="/assets/blog/client-creds-with-spring-boot/client-creds-jwt-90615dab46fe5a23d5bca2a29ec42e518683860826b70840fa2a6cea62108440.png" alt="Client credentials with JWT sequence" width="800" class="center-image" /></p>

<p>We have helper libraries in a <a href="https://github.com/okta?q=okta-jwt-">few different languages</a> and a <a href="https://github.com/okta/okta-spring-boot">Spring Boot starter</a> that will handle the local validation for you.</p>

<p><strong>NOTE:</strong> at the time of this writing <code class="highlighter-rouge">okta-spring-boot</code> only works with Spring Boot 1.5.x, see an example on <a href="https://github.com/okta/samples-java-spring/tree/master/resource-server">GitHub</a></p>

<h2 id="learn-more-about-oauth-20-and-okta">Learn More About OAuth 2.0 and Okta</h2>

<p>In this post, I’ve explained the OAuth 2.0 client credentials grant type and created small demo applications that exercised this flow (with very little code, thanks to Spring Boot!). If you have questions, leave them below or ping me (<a href="https://twitter.com/briandemers">@briandemers</a>) or <a href="https://twitter.com/oktadev">@OktaDev</a> on Twitter.</p>

<p>For more info on OAuth 2.0 and Okta check out these resources:</p>

<ul>
  <li><a href="/blog/2017/06/21/what-the-heck-is-oauth">What the Heck is OAuth?</a></li>
  <li><a href="https://www.oauth.com/">OAuth.com</a></li>
  <li><a href="/blog/2017/10/27/secure-spa-spring-boot-oauth">Secure your SPA with Spring Boot and OAuth</a></li>
</ul>


    </div>

    
    <div id="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_title = "Secure Server-to-Server Communication with Spring Boot and OAuth 2.0";
            var disqus_url = 'https://developer.okta.com/blog/2018/04/02/client-creds-with-spring-boot';

            (function () {
                var dsq = document.createElement('script');
                dsq.async = true;
                dsq.type = 'text/javascript';
                dsq.src = '//oktadevblog.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
          <noscript>
              Please enable JavaScript to view the
              <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus</a>.
         </noscript>
    </div>
    
</article>

		
</section>

		
	</div>
	<footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">
                <a href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <div class="Logo">
                        <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    </div>
                    <p>Visit okta.com</p>
                </a>
            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">
                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/change-log/">Change Log</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="https://developer.okta.com/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="https://developer.okta.com/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="https://developer.okta.com/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-aa397c892d9083236c5cb20732dde679021b9236c8142ce78177b8b184567a02.js"></script>
    <script type="text/javascript" src="/assets/myOkta-911cbafbbe079b7a5522d9cbe15bd2a5f44e1582531e88393934bec69f97696b.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
